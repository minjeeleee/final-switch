<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/subHeader :: subHeader"></head>

<head>
    <link rel="stylesheet" href="../resources/css/mypage/profile.css">
</head>
<body>

    <header th:replace="fragments/subBodyHeader :: subBodyHeader">
	</header>

    <section>

        <div class="prof-title-container">
            <div class="prof-innerwrap inner-size">

                <div class="prof-title">
                    <h1>내프로필</h1>
                </div>

                <div class="prof-img">
                    <img src="../resources/img/profileBack.png" alt="">
                </div>

            </div>

            <form class="porfile-form" th:object="${modifyForm}" th:action="|/mypage/profile?${_csrf.parameterName}=${_csrf.token}|" method="post" id="frm_modify"  enctype="multipart/form-data">
            <div class="profile-warp inner-size">

                <div class="profile-img" th:if ="${profileImage == null}">
                    <img src="../resources/img/no-img.jpg" alt="">
                </div>
                
                <div class="profile-img" th:unless ="${profileImage == null}">
                    <img th:src="${profileImage.getDownloadURL()}" alt="">
                </div>
                
                <div class="file-input">
                    <label for="profileImage">Upload new picture</label>
                    <input type="file" name="profileImage" id="profileImage" onchange="fileCheck(this.file)">
                </div>
                
            </div>

            <div class="prof-container inner-size">
                    <div class="prof-detail">
                        <p>Name</p>
                        <input type="text" th:value="${#authentication.principal.memberName}" readonly>
                    </div>
                    <div class="prof-detail">
                        <p>Email</p>
                        <input type="text" name="memberEmail" id="memberEmail" th:value="${#authentication.name}" readonly="readonly">
                    </div>
                    <div class="prof-detail">
                        <p>Password</p>
                        <input type="password" name="memberPass" id="memberPass">
                        <button type="button" name="btnPwCheck" id="btnPwCheck" class="pass-confirm">확인</button>
                        <p id="passwordCheck" class="valid-msg"></p>
                    </div>
                    <div class="prof-detail">
                        <p>New Password</p>
                        <input type="password" name="newMemberPass" id="newMemberPass" placeholder="띄어쓰기 없는 6~15자 영문 대/소문자 포함" >
                        <p th:if="${#fields.hasErrors('newMemberPass')}" th:errors="*{newMemberPass}" class="valid-msg"></p>
                    </div>
                    <div class="prof-detail">
                        <p>confirm New Password</p>
                        <input type="password">
                        <p th:if="${#fields.hasErrors('checkMemberPss')}" th:errors="*{checkMemberPss}" class="valid-msg"></p>
                    </div>
                    <div class="prof-detail">
                        <p>NickName</p>
                        <input type="text" name="memberNick" id="memberNick" size="6"  placeholder="2~6자의 한글,영문" 
						th:value="${#authentication.principal.memberNick}" required>
						<button class="pass-confirm" id="btnNickCheck">중복확인</button>
                    </div>
                    
                    <div class="prof-detail">
                        <p>Tel</p>
                        <input type="tel" id="memberTell" name="memberTell" placeholder="숫자만 입력" 
						th:value="${#authentication.principal.memberTell}" required>
						<p th:if="${#fields.hasErrors('memberTell')}" th:errors="*{memberTell}" class="valid-msg"></p>
                    </div>
                    
                    <div class="prof-detail-address">
                         <div class="address-title">
                            <p>Address</p><button type="button" id="searchAddr">주소검색</button>
                        </div>
                        <div class="address-input">
                            <input id="zipNo" name="zipNo" placeholder="우편번호" type="text" readonly="readonly"  
							th:value="${#strings.arraySplit(#strings.replace(#authentication.principal.memberAddress,'[',''),']')[0]}"
							required>
                            <input class="form-control" id="address" name="address" type="text" readonly="readonly" 
						    th:value="${#strings.arraySplit(#authentication.principal.memberAddress,']')[1]}"	
						    required>
                        </div>
                        <p th:if="${#fields.hasErrors('zipNo')}" th:errors="*{zipNo}" class="valid-msg"></p>
                    </div>
                    <button type="submit" class="form-submit">변경하기</button>

                    <div class="my-score">
                        <p>내 평점</p> <span th:text="${myRate.score}">4.0</span>
                        <span> 
                          <th:block th:if="${myRate.score} >= 1">
                       		<th:block th:each="num : ${#numbers.sequence(1,myRate.score)}">
							<i class="fas fa-star full-star"></i>
							</th:block>
                       	</th:block>
						<th:block th:if="${myRate.score%1!=0}">
							<i class="fas fa-star-half-alt"></i>
						</th:block>
						<th:block th:each="num : ${#numbers.sequence(0,5-myRate.score)}">
							<i th:unless="${num == 0}" class="far fa-star"></i>
						</th:block>
                            <i th:unless="${num == 0}" class="far fa-star"></i>
                        </th:block>    
                        <span>( [[${myRate.cnt}]]개의 평가 )</span>
                        </span>
                    </div>

                    <div class="my-score">
                        <p>내가 받은 평점</p>
                    </div>

                    <div class="star-score">
                        <div class="star">
                            <i class="fas fa-star full-star"></i>
                        </div>
                        <p>[[${rateList.one}]]%</p>
                    </div>
                    <div class="score-bar">
                        <div class="gage" th:style="|width: ${rateList.one}%|"></div>
                    </div>

                    <div class="star-score">
                        <div class="star">
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                        </div>
                        <p>[[${rateList.two}]]%</p>
                    </div>
                    <div class="score-bar">
                        <div class="gage" th:style="|width: ${rateList.two}%|"></div>
                    </div>

                    <div class="star-score">
                        <div class="star">
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                        </div>
                        <p>[[${rateList.three}]]%</p>
                    </div>
                    <div class="score-bar">
                        <div class="gage" th:style="|width: ${rateList.three}%|"></div>
                    </div>

                    <div class="star-score">
                        <div class="star">
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                        </div>
                        <p>[[${rateList.four}]]%</p>
                    </div>
                    <div class="score-bar">
                        <div class="gage" th:style="|width: ${rateList.four}%|"></div>
                    </div>

                    <div class="star-score">
                        <div class="star">
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                            <i class="fas fa-star full-star"></i>
                        </div>
                        <p>[[${rateList.five}]]%</p>
                    </div>
                    <div class="score-bar" style="margin-bottom: 30px;">
                        <div class="gage" th:style="|width: ${rateList.five}%|"></div>
                    </div>
            </div>

            <button class="get-out inner-size">탈퇴하기</button>
            </form>

        </div>


    </section>

   <footer>
	<div th:replace="fragments/footer :: footer"></div>
	</footer>
	
	<script type="text/javascript" src="../resources/js/member/modifyForm.js"></script>
    <script type="text/javascript" th:inline="javascript" >
   
    var input = document.querySelector('#profileImage');
    var preview = document.querySelector('.preview');

    input.addEventListener('change', updateImageDisplay);

    function updateImageDisplay() {
    	  while(preview.firstChild) {
    	    preview.removeChild(preview.firstChild);
    	  }

    	  const curFiles = input.files;
    	  if(curFiles.length === 0) {
    	    const para = document.createElement('p');
    	    para.textContent = 'No files currently selected for upload';
    	    preview.appendChild(para);
    	  } else {
    	    for(const file of curFiles) {
    	      const para = document.createElement('p');
    	      if(validFileType(file)) {
    	        const image = document.querySelector('.profile-img');
    	       
    	        image.src = URL.createObjectURL(file);

    	      } else {
    	        para.textContent = `File name ${file.name}: Not a valid file type. Update your selection.`;
    	        listItem.appendChild(para);
    	      }
    	    }
    	  }
    }
    	
    const fileTypes = [
    	  "image/gif",
    	  "image/jpeg",
    	  "image/png",
    	  "image/jpg"
    ];

    function validFileType(file) {
    	 return fileTypes.includes(file.type);
    }
    	
    function returnFileSize(number) {
    	if(number < 1024) {
    		return number + 'bytes';
    	} else if(number >= 1024 && number < 1048576) {
    		return (number/1024).toFixed(1) + 'KB';
    	} else if(number >= 1048576) {
    		return (number/1048576).toFixed(1) + 'MB';
    	}
    }
    
    let fileCheck = (e) => {
        
    	console.dir(e);
    	let file = e[0].name.split('.');
   		let filetype = file[file.length-1].toLowerCase();
   		if(filetype == 'jpg' || filetype == 'gif' || filetype == 'jpeg' || filetype=='png'){
   			document.querySelector(".rejectMsg").innerHTML = '';
   		} else{
   			document.querySelector(".rejectMsg").innerHTML = '<i class="fas fa-times-circle"></i>JPG/GIF/PNG 파일만 업로드 가능합니다.';
   			let files = document.getElementsByName('profileImage');
   			files[0].value='';
   			return false;
   		}
	
    }
    
   
    
    var pop;
	
    $("#searchAddr").click(function(){
    	//경로는 시스템에 맞게 수정하여 사용
    	//호출된 페이지(jusopopup.jsp)에서 실제 주소검색URL(https://www.juso.go.kr/addrlink/addrLinkUrl.do)를 호출하게 됩니다.
    	pop = window.open("/member/addrPopup","pop","width=570,height=420, scrollbars=yes, resizable=yes"); 
    })
    var jusoCallBack = function(zipNo, roadFullAddr){
    	$('#zipNo').val(zipNo);
    	$('#address').val(roadFullAddr);
    } 
    </script>

</body>
</html>

