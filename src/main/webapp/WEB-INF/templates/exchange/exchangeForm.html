<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
    <link rel="stylesheet" href="../resources/css/exchange/exchangeForm.css">
    <link rel="stylesheet" href="../resources/css/card/card2.css">
    <title>switchswitch</title>
</head>
<body>
    
    <section class="exchange-section">
		<form id="submit" th:action="@{/exchange/exchangeForm}" method="post">
        <div class="exchange-container">
            <div class="list-info">
                <div class="mycard-list-container">
                    <p>내 카드 리스트</p>
	                <div class="mycard-list">
                    	<th:block th:if="${cardlist}">
                    		<div class="card-container" style="width:180px;" 
                    			th:each="card : ${cardlist}" th:object="${card}"
                    			th:id="*{card.cardIdx}" onclick="transfer(this)">
                    			<input type="hidden" th:value="*{card.cardIdx}">
	                            <div class="card-name">
	                                <p>[[*{card.name}]]</p>
	                            </div>
	                            <div class="grade-container">
	                                <div class="icon">
	                                    <!-- 아이콘 변경 -->
	                                    <input type="hidden" th:value="*{card.category}">
	                                    <i id="icon-val"></i>
	                                </div>
	                                <div class="user-grade">
	                                    <p>사용자 평점</p>
	                                    <!-- 사용자 별점 -->
	                                    <div class="star">
	                                    	<th:block th:if="${myRate} >= 1">
	                                    		<th:block th:each="num : ${#numbers.sequence(1,myRate)}">
												<i class="fas fa-star full-star"></i>
												</th:block>
	                                    	</th:block>
											<th:block th:if="${myRate%1!=0}">
												<i class="fas fa-star-half-alt"></i>
											</th:block>
											<th:block th:each="num : ${#numbers.sequence(0,5-myRate)}">
												<i th:unless="${num == 0}" class="far fa-star"></i>
											</th:block>
	                                    </div>
	                                </div>
	                                <div class="item-grade">
	                                    <p>물건 평점</p>
	                                    <!-- 물건 별점 -->
	                                    <div class="star">
	                                    	<th:block th:each="num : *{#numbers.sequence(1,card.condition)}">
												<i class="fas fa-star full-star"></i>
											</th:block>
											<th:block th:each="num : *{#numbers.sequence(0,5-card.condition)}">
												<i th:unless="${num == 0}" class="far fa-star"></i>
											</th:block>
	                                    </div>
	                                </div>
	                            </div>
                            <div class="address">
                                <!-- 주소 -->
                                <p>지역 <span th:text="*{card.region}"></span> <span th:text="*{card.regionDetail}"></span></p>
                            </div>
                            <div class="card">
                            	<input type="hidden" th:value="*{card.condition}">
                                <img class="card-box" alt="">
                                <div class="card-img">
                                    <!-- 카드 물건 이미지 -->
                                    <img th:src="*{fileDTO.getDownloadURL()}" alt="">
                                </div>
                            </div>
                        </div>
                    	</th:block>
                    </div>
                </div>
            </div>
            <div class="wishCard">
                <p>교환 희망 카드 리스트</p>
                <input type="hidden" name="wishCardIdx" th:value="${wishCard.cardInfo.cardIdx}">
                <div class="wishCard-container">
                    <div class="top-container">
                        <div class="card-container" style="width: 180px;">
                            <div class="card-name">
                                <p>[[${wishCard.cardInfo.name}]]</p>
                            </div>
                            <div class="grade-container">
                                <div class="icon">
                                    <!-- 아이콘 변경 -->
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div class="user-grade">
                                    <p>사용자 평점</p>
                                    <!-- 사용자 별점 -->
                                    <div class="star">
                                    <th:block th:if="${userRate} >= 1">
	                                    		<th:block th:each="num : ${#numbers.sequence(1,userRate)}">
												<i class="fas fa-star full-star"></i>
												</th:block>
	                                    	</th:block>
											<th:block th:if="${userRate%1!=0}">
												<i class="fas fa-star-half-alt"></i>
											</th:block>
											<th:block th:each="num : ${#numbers.sequence(0,5-userRate)}">
												<i th:unless="${num == 0}" class="far fa-star"></i>
											</th:block>
                                    </div>
                                </div>
                                <div class="item-grade">
                                    <p>물건 평점</p>
                                    <!-- 물건 별점 -->
                                    <div class="star">
	                                    	<th:block th:each="num : ${#numbers.sequence(1,wishCard.cardInfo.condition)}">
												<i class="fas fa-star full-star"></i>
											</th:block>
											<th:block th:each="num : ${#numbers.sequence(0,5-wishCard.cardInfo.condition)}">
												<i th:unless="${num == 0}" class="far fa-star"></i>
											</th:block>
	                                    </div>
                                </div>
                            </div>
                            <div class="address">
                                <!-- 주소 -->
                                <p>지역 <span th:text="${wishCard.cardInfo.region}"></span> <span th:text="${wishCard.cardInfo.regionDetail}"></span></p>
                            </div>
                            <div class="card">
                                <input type="hidden" th:value="${wishCard.cardInfo.condition}">
                                <img class="card-box" alt="">
                                <div class="card-img">
                                    <!-- 카드 물건 이미지 -->
                                   <img th:src="${wishCard.fileDTO.getDownloadURL()}" alt="">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="exchange-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="bottom-container" id="appendArea">
                        <!-- 카드 추가 -->
                        <!-- 교환요청 버튼 클릭 시 카드 idx list 생성해서 넘기기, forEach? -->
                        
                   
                   
                    </div>
                </div>
            </div>
            <div class="point">
                <div class="balance">
                    <div class="balance-inner">
                        <p>보유 Point </p>
                        <span>[[${balance}]]P</span>
                    </div>
                    <div class="balance-inner">
                        <p>사용 가능 Point </p>
                        <span>[[${availableBal}]]P</span>
                        <input type="hidden" id="available_bal" name="availableBal" th:value="${availableBal}">
                    </div>
                </div>
                <div class="proposal">
                    <div class="proposal-inner">
                        <p>제시 잔액</p>
                        <input type="number" id="offerPoint" name="offerPoint" onchange="checkBalance(this)"><span>P</span>
                    </div>
                </div>
            </div>
            <div class="button">
                <button id="request-btn" type="button">요청</button>
                <button type="button">취소</button>
            </div>
        </div>
        </form>

    </section>
<script type="text/javascript" th:inline="javascript" >
var arr = [];

function transfer(e) {
	let appendArea;
	
	if(e.parentElement.className == 'mycard-list'){
		if(document.querySelector("#appendArea").childElementCount < 4){
			appendArea = document.querySelector("#appendArea");
			let cardIdx = e.getElementsByTagName("input")[0].value;
			let input = document.createElement("input");
			input.setAttribute("type","hidden");
			input.setAttribute("name","cardIdxList");
			input.setAttribute("value",cardIdx);
			e.appendChild(input);
			appendArea.appendChild(e);
		} else {
			alert("카드는 최대 4개만 교환 가능합니다.");
		}
	} else {
		appendArea = document.querySelector(".mycard-list");
		e.lastChild.remove();
		appendArea.appendChild(e);
	}
}

function checkBalance(e){
	let myBalance = parseInt("문자열 아님", document.querySelector("#available_bal").value);
	if(e.value == ""){
		e.value = 0;
	}
	let offerPoint =  parseInt("문자열 아님", e.value);
	if(e.value > myBalance){
		alert("사용 가능 포인트보다 많은 포인트는 제시할 수 없습니다.");
		e.value = 0;
	}
}

document.querySelector("#request-btn").addEventListener("click", function(e){
	let checkPoint = document.querySelector("#offerPoint");
	checkBalance(checkPoint);
	let cardCount = document.querySelector(".bottom-container").childElementCount;
	if(cardCount == 0){
		alert("교환할 카드를 선택해 주세요.");
		e.preventDefault();
	} else {
		document.querySelector("#submit").submit();
	}
})

document.querySelectorAll(".card-box").forEach(function(e){
	switch(e.previousElementSibling.value){
	case '1' : e.setAttribute("src","../resources/img/ddongCard.png"); break;
	case '2' : e.setAttribute("src","../resources/img/BrownCard.png"); break;
	case '3' : e.setAttribute("src","../resources/img/silverCard.png"); break;
	case '4' : e.setAttribute("src","../resources/img/goldCard.png"); break;
	case '5' : e.setAttribute("src","../resources/img/diaCard.png"); break;
	default : console.dir("error!!!");
	};
})

document.querySelectorAll("#icon-val").forEach(function(e){
	switch(e.previousElementSibling.value){
	case '전자기기/생활가전' : e.setAttribute("class","fas fa-bolt"); break;
	case '가구/인테리어' : e.setAttribute("class","fas fa-couch"); break;
	case '유아동' : e.setAttribute("class","fal fa-baby"); break;
	case '생활/가공식품' : e.setAttribute("class","fas fa-utensils"); break;
	case '스포츠/레저' : e.setAttribute("class","fas fa-basketball-ball"); break;
	case '패션/잡화' : e.setAttribute("class","fas fa-tshirt"); break;
	case '게임/만화' : e.setAttribute("class","fas fa-gamepad"); break;
	case '뷰티/미용' : e.setAttribute("class","fas fa-air-freshener"); break;
	case '반려 동물 용품' : e.setAttribute("class","fas fa-paw"); break;
	case '도서/티켓/음반' : e.setAttribute("class","fas fa-compact-disc"); break;
	case '기타' : e.setAttribute("class","fas fa-cogs"); break;
	default : console.dir("error!!!");
	};
})


</script>
</body>
</html>